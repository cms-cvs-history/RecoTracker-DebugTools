process TESTOUTLIERS = {
    
    service = MessageLogger {
	untracked vstring destinations = {"cout"}
	untracked vstring categories    = { "FwkSummary","RFIOFile","FwkReport","TestOutliers"}
        untracked PSet cout            = {
            #untracked string threshold = "DEBUG"
            untracked string threshold = "INFO"
            untracked PSet default   = { untracked int32 limit = 0  }
            untracked PSet TrackAssociator = { untracked int32 limit = 0 }
            untracked PSet TrackValidator = { untracked int32 limit = -1 }
            untracked PSet TrackFitters = { untracked int32 limit = 0 }
            untracked PSet TrackProducer = { untracked int32 limit = 0}
            untracked PSet TestOutliers = { untracked int32 limit = -1 }
            untracked PSet FwkSummary = { untracked int32 limit = -1 }
            untracked PSet RFIOFile = { untracked int32 limit = -1 }
            untracked PSet FwkReport =  { untracked int32 limit = -1
                untracked int32 reportEvery = 10 }
        }
    }
    
    untracked PSet maxEvents = {untracked int32 input = -1}
    source = PoolSource { 
	untracked vstring fileNames = {
	    'file:single_mu_10_1.root'
	}
    }
    
    # Track Associators
    include "SimTracker/TrackAssociation/data/TrackAssociatorByChi2.cfi"
    include "SimTracker/TrackAssociation/data/TrackAssociatorByHits.cfi"
    
    # Filters
    include "Validation/RecoTrack/data/cuts.cff"
    
    # Track Validator    
    include "Validation/RecoTrack/data/MultiTrackValidator.cff"
    replace multiTrackValidator.label = {myGeneralTracks::MULTITRACKVALIDATOR}
    replace multiTrackValidator.out = "validCut20.root"
    replace cutsTPFake.src = mergedtruth:MergedTrackTruth
    replace cutsTPEffic.src = mergedtruth:MergedTrackTruth
    
    include "SimGeneral/MixingModule/data/mix_none.cfi"
    
    service = Timing { 	untracked bool summaryOnly = true } 
    untracked PSet options = {
	untracked bool wantSummary = true
	untracked bool makeTriggerResults = false  
    }
    include "RecoTracker/Configuration/data/RecoTracker.cff"
    include "CalibTracker/Configuration/data/Tracker_FakeConditions.cff"
    
    ### Final Fitting
    es_module myFittingSmootherWithOutlierRejection = RKFittingSmoother
    from "TrackingTools/TrackFitters/data/RungeKuttaKFFittingSmootherESProducer.cfi"
    replace myFittingSmootherWithOutlierRejection.ComponentName = "myFittingSmootherWithOutlierRejection"
    replace myFittingSmootherWithOutlierRejection.EstimateCut = 20
    replace myFittingSmootherWithOutlierRejection.MinNumberOfHits = 3
    module  myPreFilterCmsTracks = ctfWithMaterialTracks from "RecoTracker/TrackProducer/data/CTFFinalFitWithMaterial.cfi"
    replace myPreFilterCmsTracks.src = "newTrackCandidateMaker"
    replace myPreFilterCmsTracks.TTRHBuilder =  "WithAngleAndTemplate"
    replace myPreFilterCmsTracks.Fitter = "myFittingSmootherWithOutlierRejection"
    replace myPreFilterCmsTracks.AlgorithmName =  "ctf"
    module  myWithLooseQuality = selectLoose from "RecoTracker/FinalTrackSelectors/data/selectLoose.cfi"
    replace myWithLooseQuality.src              = myPreFilterCmsTracks
    replace myWithLooseQuality.keepAllTracks    = false // we only keep hthose who pass the filter
    replace myWithLooseQuality.copyExtras       = true
    replace myWithLooseQuality.copyTrajectories = true
    module  myWithTightQuality = selectTight from "RecoTracker/FinalTrackSelectors/data/selectTight.cfi"
    replace myWithTightQuality.src              = myWithLooseQuality
    replace myWithTightQuality.keepAllTracks    = false
    replace myWithTightQuality.copyExtras       = true
    replace myWithTightQuality.copyTrajectories = true
    module  myGeneralTracks = selectHighPurity from "RecoTracker/FinalTrackSelectors/data/selectHighPurity.cfi"
    replace myGeneralTracks.src              = myWithTightQuality
    replace myGeneralTracks.keepAllTracks    = false
    replace myGeneralTracks.copyExtras       = true
    replace myGeneralTracks.copyTrajectories = true
    sequence myTracksWithQuality = { myWithLooseQuality, myWithTightQuality, myGeneralTracks }
    
    es_module myFittingSmootherWithOutlierRejectionOld = RKFittingSmoother
    from "TrackingTools/TrackFitters/data/RungeKuttaKFFittingSmootherESProducer.cfi"
    replace myFittingSmootherWithOutlierRejectionOld.ComponentName = "myFittingSmootherWithOutlierRejectionOld"
    replace myFittingSmootherWithOutlierRejectionOld.EstimateCut = -1
    replace myFittingSmootherWithOutlierRejectionOld.MinNumberOfHits = 3
    module  myPreFilterCmsTracksOld = ctfWithMaterialTracks from "RecoTracker/TrackProducer/data/CTFFinalFitWithMaterial.cfi"
    replace myPreFilterCmsTracksOld.src = "newTrackCandidateMaker"
    replace myPreFilterCmsTracksOld.TTRHBuilder =  "WithAngleAndTemplate"
    replace myPreFilterCmsTracksOld.Fitter = "myFittingSmootherWithOutlierRejectionOld"
    replace myPreFilterCmsTracksOld.AlgorithmName =  "ctf"
    module  myWithLooseQualityOld = selectLoose from "RecoTracker/FinalTrackSelectors/data/selectLoose.cfi"
    replace myWithLooseQualityOld.src              = myPreFilterCmsTracksOld
    replace myWithLooseQualityOld.keepAllTracks    = false // we only keep hthose who pass the filter
    replace myWithLooseQualityOld.copyExtras       = true
    replace myWithLooseQualityOld.copyTrajectories = true
    module  myWithTightQualityOld = selectTight from "RecoTracker/FinalTrackSelectors/data/selectTight.cfi"
    replace myWithTightQualityOld.src              = myWithLooseQualityOld
    replace myWithTightQualityOld.keepAllTracks    = false
    replace myWithTightQualityOld.copyExtras       = true
    replace myWithTightQualityOld.copyTrajectories = true
    module  myGeneralTracksOld = selectHighPurity from "RecoTracker/FinalTrackSelectors/data/selectHighPurity.cfi"
    replace myGeneralTracksOld.src              = myWithTightQualityOld
    replace myGeneralTracksOld.keepAllTracks    = false
    replace myGeneralTracksOld.copyExtras       = true
    replace myGeneralTracksOld.copyTrajectories = true
    sequence myTracksWithQualityOld = { myWithLooseQualityOld, myWithTightQualityOld, myGeneralTracksOld }
    
    #include "RecoLocalTracker/SiPixelRecHits/data/PixelCPETemplateReco.cfi"
    #replace ttrhbwr.PixelCPE = "PixelCPETemplateReco"
    #replace MeasurementTracker.PixelCPE = "PixelCPETemplateReco"
    #replace MeasurementTracker.StripCPE = "StripCPEfromTrackAngle"
    
    module test = TestOutliers {
        untracked InputTag tracksOut = myGeneralTracks::MULTITRACKVALIDATOR
        untracked InputTag tracksOld = myGeneralTracksOld::MULTITRACKVALIDATOR
        untracked InputTag tp = cutsTPFake
        string  out   = "testT20.root"
        PSet TrackAssociatorByHitsPSetOld = {
            bool associateStrip = true
            bool associatePixel = true
            bool associateRecoTracks = true
            bool AbsoluteNumberOfHits = false
            string SimToRecoDenominator = "sim"
            double MinHitCut = 0.5
            bool UsePixels = true
            bool UseGrouped = true
            bool UseSplitting = false
            bool ThreeHitTracksAreSpecial = true
            vstring ROUList = {
                #For running only strip or pixel comment out the appropriate strings
                #TIB
                "TrackerHitsTIBLowTof","TrackerHitsTIBHighTof",
                #TID
                "TrackerHitsTIDLowTof","TrackerHitsTIDHighTof",
                #TOB
                "TrackerHitsTOBLowTof","TrackerHitsTOBHighTof",
                #TEC
                "TrackerHitsTECLowTof","TrackerHitsTECHighTof",
                #BPIX
                "TrackerHitsPixelBarrelLowTof","TrackerHitsPixelBarrelHighTof",
                #FPIX
                "TrackerHitsPixelEndcapLowTof","TrackerHitsPixelEndcapHighTof"}
        }
        PSet TrackAssociatorByHitsPSetOut = {
            bool associateStrip = true
            bool associatePixel = true
            bool associateRecoTracks = true
            bool AbsoluteNumberOfHits = false
            string SimToRecoDenominator = "sim"
            double MinHitCut = 0.5
            bool UsePixels = true
            bool UseGrouped = true
            bool UseSplitting = false
            bool ThreeHitTracksAreSpecial = true
            vstring ROUList = {
                #For running only strip or pixel comment out the appropriate strings
                #TIB
                "TrackerHitsTIBLowTof","TrackerHitsTIBHighTof",
                #TID
                "TrackerHitsTIDLowTof","TrackerHitsTIDHighTof",
                #TOB
                "TrackerHitsTOBLowTof","TrackerHitsTOBHighTof",
                #TEC
                "TrackerHitsTECLowTof","TrackerHitsTECHighTof",
                #BPIX
                "TrackerHitsPixelBarrelLowTof","TrackerHitsPixelBarrelHighTof",
                #FPIX
                "TrackerHitsPixelEndcapLowTof","TrackerHitsPixelEndcapHighTof"}
        }
    }
    
    #path p1 = {myPreFilterCmsTracks, myTracksWithQuality}
    path p1 = {myPreFilterCmsTracksOld, myTracksWithQualityOld, myPreFilterCmsTracks, myTracksWithQuality}
    path p2 = {cutsTPEffic,cutsTPFake,multiTrackValidator}
    path p3 = {test}
}
